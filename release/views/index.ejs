<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Scraper UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    <div class="container mx-auto p-4 max-w-6xl">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-blue-500">TradingView Live</h1>
                <p class="text-gray-400 text-sm">Real-time market data</p>
            </div>
            <div class="text-right">
                <div id="connectionStatus" class="text-xs text-yellow-500">Connecting...</div>
            </div>
        </header>

        <!-- Search Section -->
        <div class="relative mb-8">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search symbol (e.g. AAPL, BTCUSDT)..." 
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors text-lg"
                autocomplete="off"
            >
            <div id="searchResults" class="absolute w-full bg-gray-800 border border-gray-700 rounded-lg mt-2 shadow-xl z-50 hidden max-h-60 overflow-y-auto scrollbar-hide"></div>
        </div>

        <!-- Market Overview Grid -->
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-300">Market Overview</h2>
            <div id="marketGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- Detailed View (Hidden by default) -->
        <div id="detailView" class="hidden bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg mb-8">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 id="detailSymbol" class="text-4xl font-bold text-white">---</h2>
                    <p id="detailExchange" class="text-gray-400 text-lg">---</p>
                </div>
                <div class="text-right">
                    <div id="detailPrice" class="text-5xl font-mono font-bold text-white">---</div>
                    <div id="detailChange" class="text-xl font-mono mt-1">---</div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-700/50 p-3 rounded-lg">
                    <div class="text-gray-400 text-xs uppercase">Open</div>
                    <div id="detailOpen" class="font-mono text-lg">---</div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded-lg">
                    <div class="text-gray-400 text-xs uppercase">High</div>
                    <div id="detailHigh" class="font-mono text-lg">---</div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded-lg">
                    <div class="text-gray-400 text-xs uppercase">Low</div>
                    <div id="detailLow" class="font-mono text-lg">---</div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded-lg">
                    <div class="text-gray-400 text-xs uppercase">Volume</div>
                    <div id="detailVolume" class="font-mono text-lg">---</div>
                </div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="mt-8">
            <h2 class="text-xl font-bold mb-4 text-gray-300">WebSocket Debug Log</h2>
            <div id="debugLog" class="bg-black rounded-lg p-4 font-mono text-xs h-64 overflow-y-auto border border-gray-700">
                <!-- Logs injected here -->
            </div>
        </div>

    </div>

    <script>
        const socket = io();
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const marketGrid = document.getElementById('marketGrid');
        const detailView = document.getElementById('detailView');
        const debugLog = document.getElementById('debugLog');
        
        let searchTimeout;
        let activeDetailSymbol = null;
        const cards = {}; // Map symbol -> element

        // Debug Log
        socket.on('debug_log', (log) => {
            const div = document.createElement('div');
            div.className = 'mb-1 border-b border-gray-800 pb-1';
            const color = log.direction === 'TX' ? 'text-blue-400' : 'text-green-400';
            div.innerHTML = `
                <span class="text-gray-500">[${log.time.split('T')[1].split('.')[0]}]</span>
                <span class="${color} font-bold">${log.direction}</span>: 
                <span class="text-gray-300 break-all">${log.msg}</span>
            `;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // Limit log size
            if (debugLog.children.length > 100) {
                debugLog.removeChild(debugLog.firstChild);
            }
        });

        // Initial Connection
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').className = 'text-xs text-green-500';
            socket.emit('request_top_stocks');
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'text-xs text-red-500';
        });

        // Handle Updates
        socket.on('ticker_update', ({ symbol, data }) => {
            updateCard(symbol, data);
            if (activeDetailSymbol === symbol) {
                updateDetailView(data);
            }
        });

        function getCardId(symbol) {
            return 'card-' + symbol.replace(/[^a-zA-Z0-9]/g, '');
        }

        function updateCard(symbol, data) {
            const shortSymbol = symbol.split(':')[1] || symbol;
            const exchange = symbol.split(':')[0] || '';
            
            let card = cards[symbol];
            if (!card) {
                // Create new card
                card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-blue-500 cursor-pointer transition-all';
                card.onclick = () => openDetail(symbol, exchange);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-lg">${shortSymbol}</span>
                        <span class="text-xs text-gray-500">${exchange}</span>
                    </div>
                    <div class="text-2xl font-mono font-bold mb-1" data-field="lp">---</div>
                    <div class="text-sm font-mono" data-field="ch">---</div>
                `;
                marketGrid.appendChild(card);
                cards[symbol] = card;
            }

            // Update fields
            if (data.lp !== undefined) {
                const el = card.querySelector('[data-field="lp"]');
                const oldVal = parseFloat(el.textContent);
                el.textContent = data.lp;
                
                // Flash color
                if (oldVal) {
                    el.style.color = data.lp > oldVal ? '#4ade80' : '#f87171';
                    setTimeout(() => el.style.color = '', 300);
                }
            }

            if (data.ch !== undefined && data.chp !== undefined) {
                const el = card.querySelector('[data-field="ch"]');
                const isPos = data.ch >= 0;
                el.textContent = `${isPos ? '+' : ''}${data.ch} (${isPos ? '+' : ''}${data.chp}%)`;
                el.className = `text-sm font-mono ${isPos ? 'text-green-500' : 'text-red-500'}`;
            }
        }

        function openDetail(symbol, exchange) {
            activeDetailSymbol = symbol;
            detailView.classList.remove('hidden');
            
            const shortSymbol = symbol.split(':')[1] || symbol;
            document.getElementById('detailSymbol').textContent = shortSymbol;
            document.getElementById('detailExchange').textContent = exchange;
            
            // Reset values
            ['detailPrice', 'detailChange', 'detailOpen', 'detailHigh', 'detailLow', 'detailVolume'].forEach(id => {
                document.getElementById(id).textContent = '---';
            });

            // If we don't have a card for this (searched item), we need to subscribe
            if (!cards[symbol]) {
                socket.emit('subscribe', symbol);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateDetailView(data) {
            const update = (id, val) => {
                if (val !== undefined) document.getElementById(id).textContent = val;
            };

            update('detailPrice', data.lp);
            update('detailOpen', data.open_price);
            update('detailHigh', data.high_price);
            update('detailLow', data.low_price);
            update('detailVolume', data.volume);

            if (data.ch !== undefined && data.chp !== undefined) {
                const el = document.getElementById('detailChange');
                const isPos = data.ch >= 0;
                el.textContent = `${isPos ? '+' : ''}${data.ch} (${isPos ? '+' : ''}${data.chp}%)`;
                el.className = `text-xl font-mono mt-1 ${isPos ? 'text-green-500' : 'text-red-500'}`;
            }
        }

        // Search Logic
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 1) {
                searchResults.classList.add('hidden');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/search?q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    renderSearchResults(data);
                } catch (err) {
                    console.error(err);
                }
            }, 300);
        });

        function renderSearchResults(results) {
            searchResults.innerHTML = '';
            if (!results || results.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }

            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-0 flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-white">${item.symbol}</span>
                        <span class="text-gray-400 text-sm ml-2">${item.description}</span>
                    </div>
                    <span class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">${item.exchange}</span>
                `;
                div.onclick = () => {
                    const fullSymbol = `${item.exchange}:${item.symbol}`;
                    searchInput.value = '';
                    searchResults.classList.add('hidden');
                    openDetail(fullSymbol, item.exchange);
                    socket.emit('subscribe', fullSymbol);
                };
                searchResults.appendChild(div);
            });
            searchResults.classList.remove('hidden');
        }

        // Close dropdown on click outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });
    </script>
</body>
</html>